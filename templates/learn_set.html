<!doctype html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nauka: {{ zestaw.nazwa }} - MÄ…dra Nauka</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MÄ…dra Nauka">
    <link rel="manifest" href="{{ url_for('manifest') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('favicon') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('icons', filename='icon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('icons', filename='icon-16x16.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('icons', filename='icon-192x192.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('icons', filename='icon-192x192.png') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/learn.css') }}">
</head>
<body>
    <div class="app">
        <div class="bg-blob a"></div>
        <div class="bg-blob b"></div>

        <div class="card">
            <button id="finishEarly" class="btn ghost" style="margin-bottom: 20px; width: fit-content;">â† ZakoÅ„cz naukÄ™</button>
            
            <h1>{{ zestaw.nazwa }}</h1>
            <p class="subtitle">Ucz siÄ™ z fiszkami</p>

            <div id="syncStatus" style="display:none; margin: 12px 0; font-size: 13px; color: #fbbf24;">
                Brak internetu â€” wyniki zostanÄ… zapisane, gdy wrÃ³cisz online.
            </div>

            <div class="progress-text" id="progressText"></div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>

            <div class="flashcard-container">
                <div class="flashcard" id="flashcard" onclick="flipCard()">
                    <div class="flashcard-face flashcard-front">
                        <div class="flashcard-label">Pytanie</div>
                        <div class="flashcard-content" id="questionText"></div>
                        <div class="flashcard-hint">ğŸ‘† Kliknij, aby zobaczyÄ‡ odpowiedÅº</div>
                    </div>
                    <div class="flashcard-face flashcard-back">
                        <div class="flashcard-label">OdpowiedÅº</div>
                        <div class="flashcard-content" id="answerText"></div>
                        <div class="flashcard-hint">ğŸ‘† Kliknij, aby wrÃ³ciÄ‡ do pytania</div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" id="action-buttons">
                <button type="button" class="btn-action btn-not-understood" onclick="markAnswer(false)">âœ—</button>
                <button type="button" class="btn-action btn-understood" onclick="markAnswer(true)">âœ“</button>
            </div>

            <div id="finishPanel" style="display:none; margin-top: 16px; text-align: center;">
                <p style="color: #94a3b8; margin-bottom: 12px;">To juÅ¼ wszystko! Zapisz wyniki.</p>
                <button id="submitResults" class="btn primary" style="background: linear-gradient(90deg, #10b981, #059669);">Zapisz i pokaÅ¼ podsumowanie</button>
            </div>
        </div>
    </div>

    <script>
        const cards = {{ zestaw.karty | tojson }};
        const order = {{ order | tojson }};
        const mode = {
            random: {{ 'true' if random_order else 'false' }},
            review: {{ 'true' if review_mode else 'false' }}
        };
        const setId = "{{ zestaw.id }}";

        let isFlipped = false;
        let currentIndex = 0;
        let results = Array(cards.length).fill(null);
        const stateKey = `learn_state_${setId}`;

        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        const questionText = document.getElementById('questionText');
        const answerText = document.getElementById('answerText');
        const finishPanel = document.getElementById('finishPanel');
        const actionButtons = document.getElementById('action-buttons');
        const syncStatus = document.getElementById('syncStatus');
        const submitButton = document.getElementById('submitResults');
        const finishEarlyButton = document.getElementById('finishEarly');

        function updateProgress() {
            const total = cards.length;
            const indexDisplay = Math.min(currentIndex + 1, total);
            progressText.textContent = `Fiszka ${indexDisplay} z ${total}`;
            const percent = total > 0 ? ((currentIndex) / total) * 100 : 0;
            progressFill.style.width = `${Math.min(percent, 100)}%`;
        }

        function renderCard() {
            if (currentIndex >= cards.length) {
                actionButtons.style.display = 'none';
                finishPanel.style.display = 'block';
                return;
            }

            const card = cards[currentIndex];
            questionText.textContent = card.tekst || '';
            answerText.textContent = card.odpowiedz || '';
            updateProgress();

            const flashcard = document.getElementById('flashcard');
            flashcard.classList.remove('flipped');
            isFlipped = false;
        }

        function flipCard() {
            const card = document.getElementById('flashcard');
            
            // PrzeÅ‚Ä…cz stan karty
            if (!isFlipped) {
                card.classList.add('flipped');
                isFlipped = true;
            } else {
                // ObrÃ³Ä‡ z powrotem na pytanie
                card.classList.remove('flipped');
                isFlipped = false;
            }
        }

        function markAnswer(understood) {
            if (currentIndex >= cards.length) return;
            results[currentIndex] = understood;
            currentIndex += 1;
            localStorage.setItem(stateKey, JSON.stringify({
                currentIndex: currentIndex,
                results: results
            }));
            renderCard();
        }

        async function submitResults() {
            // WypeÅ‚nij brakujÄ…ce wyniki wartoÅ›ciÄ… null dla kart, ktÃ³rych nie dotkniÄ™to
            const completeResults = results.slice();
            while (completeResults.length < cards.length) {
                completeResults.push(null);
            }

            const payload = {
                results: completeResults,
                order: order,
                mode: mode
            };

            try {
                const response = await fetch(`{{ url_for('learn_submit', set_id=zestaw.id) }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('submit_failed');
                const data = await response.json();
                localStorage.removeItem(`learn_pending_${setId}`);
                localStorage.removeItem(stateKey);
                window.location.href = data.redirect || "{{ url_for('learn_summary', set_id=zestaw.id) }}";
            } catch (err) {
                console.error('Submit error:', err);
                localStorage.setItem(`learn_pending_${setId}`, JSON.stringify(payload));
                syncStatus.style.display = 'block';
            }
        }

        // ObsÅ‚uga klawiatury: spacja = obrÃ³t, strzaÅ‚ka lewo/prawo = decyzja
        document.addEventListener('keydown', function(e) {
            // Nie przechwytuj w polach edycji
            const tag = (e.target.tagName || '').toLowerCase();
            if (tag === 'input' || tag === 'textarea') return;
            if (e.repeat) return;

            if (e.code === 'Space') {
                e.preventDefault();
                flipCard();
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                markAnswer(false);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                markAnswer(true);
            }
        });

        submitButton.addEventListener('click', submitResults);
        finishEarlyButton.addEventListener('click', submitResults);

        // SprÃ³buj wysÅ‚aÄ‡ zalegÅ‚e wyniki po odzyskaniu internetu
        window.addEventListener('online', () => {
            const pending = localStorage.getItem(`learn_pending_${setId}`);
            if (pending) {
                submitResults();
            }
        });

        // Inicjalizacja
        const storedState = localStorage.getItem(stateKey);
        if (storedState) {
            try {
                const parsed = JSON.parse(storedState);
                if (Array.isArray(parsed.results) && typeof parsed.currentIndex === 'number') {
                    results = parsed.results.slice(0, cards.length);
                    currentIndex = Math.min(parsed.currentIndex, cards.length);
                }
            } catch (e) {
                localStorage.removeItem(stateKey);
            }
        }

        renderCard();
    </script>
</body>
</html>
